<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invoice Genie — Invoice Generator</title>

  <!-- Fonts & icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">

  <!-- Simple CSS (tailored for clarity & modern look) -->
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --muted:#64748b; --accent:#0ea5a4; --danger:#ef4444; --success:#10b981;
      --glass: rgba(255,255,255,0.6);
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    [data-theme="dark"]{
      --bg:#0b1220; --card:#0f1724; --muted:#94a3b8; --accent:#06b6d4; --glass: rgba(255,255,255,0.03);
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#e9f0f7);min-height:100vh;color:var(--muted);padding:18px}
    .app{max-width:1100px;margin:18px auto}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{margin:0;font-size:20px;color:var(--accent);font-weight:700}
    .controls{display:flex;gap:8px;align-items:center}
    button,select,input{font-family:inherit}
    button{background:var(--accent);border:0;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn-ghost{background:transparent;color:var(--muted);border:1px solid rgba(0,0,0,0.06)}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:14px}
    .grid{display:grid;gap:12px}
    .grid.cols-3{grid-template-columns:1fr 1fr 1fr}
    .row{display:flex;gap:12px;align-items:center}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="text"],input[type="number"],select,textarea,input[type="date"]{
      width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef8;background:transparent;color:inherit
    }
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;text-align:left;border-bottom:1px solid #edf4fb}
    .actions{display:flex;gap:8px}
    .pill{display:inline-block;padding:6px 8px;border-radius:999px;font-size:12px}
    .status-draft{background:#f1f5f9;color:#0f1724}
    .status-paid{background:rgba(16,185,129,0.12);color:var(--success)}
    .status-overdue{background:rgba(239,68,68,0.12);color:var(--danger)}
    .line-items{border-radius:8px;border:1px dashed #e6eef8;padding:8px}
    .line{display:flex;gap:8px;margin-bottom:8px}
    .line input{flex:1}
    .total-row{display:flex;justify-content:space-between;align-items:center;margin-top:10px}
    .big-total{font-size:20px;color:var(--accent);font-weight:700}
    .template-preview{border-radius:8px;padding:10px;border:1px solid #edf4fb;background:linear-gradient(180deg,rgba(0,0,0,0.01),transparent)}
    .topbar{display:flex;gap:10px;align-items:center}
    .stats{display:flex;gap:10px;align-items:center}
    .stat{background:var(--glass);padding:10px;border-radius:10px;min-width:110px;text-align:center}
    .qr {max-width:120px}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){
      .grid.cols-3{grid-template-columns:1fr}
      header{flex-direction:column;align-items:flex-start;gap:10px}
    }
  </style>
</head>
<body>
  <div class="app" id="app" data-theme="light">
    <header>
      <div>
        <h1>Invoice Genie</h1>
        <div class="muted small">Generate, manage, and export invoices — with crypto pricing & QR</div>
      </div>

      <div class="controls">
        <select id="themeSelect" title="Theme">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
        </select>

        <select id="templateSelect" title="Template">
          <option value="simple">Simple</option>
          <option value="modern">Modern</option>
          <option value="minimal">Minimal</option>
        </select>

        <button id="btnNewInvoice">+ New Invoice</button>
        <button id="btnNewClient" class="btn-ghost">+ New Client</button>
      </div>
    </header>

    <!-- Dashboard -->
    <section class="card grid cols-3" id="dashboard">
      <div>
        <div class="small muted">Invoices</div>
        <div style="font-weight:700;font-size:20px" id="statInvoices">0</div>
      </div>
      <div>
        <div class="small muted">Paid</div>
        <div style="font-weight:700;font-size:20px" id="statPaid">0</div>
      </div>
      <div>
        <div class="small muted">Outstanding</div>
        <div style="font-weight:700;font-size:20px" id="statOutstanding">0</div>
      </div>
    </section>

    <!-- Invoice list & controls -->
    <section class="card">
      <div class="row" style="justify-content:space-between;">
        <div style="display:flex;gap:8px;align-items:center">
          <label class="small muted" style="margin:0 8px 0 0">Search</label>
          <input id="searchInput" placeholder="Invoice # or client name" style="width:240px"/>
          <select id="filterStatus">
            <option value="all">All statuses</option>
            <option value="draft">Draft</option>
            <option value="sent">Sent</option>
            <option value="paid">Paid</option>
            <option value="overdue">Overdue</option>
          </select>
          <select id="sortSelect">
            <option value="date_desc">Date (newest)</option>
            <option value="date_asc">Date (oldest)</option>
            <option value="amount_desc">Amount (high→low)</option>
            <option value="amount_asc">Amount (low→high)</option>
          </select>
        </div>

        <div class="row">
          <button id="btnExportCSV" class="btn-ghost">Export CSV</button>
          <button id="btnRefreshPrices" class="btn-ghost">Refresh Crypto Prices</button>
        </div>
      </div>

      <div style="margin-top:12px; overflow:auto; max-height:420px;">
        <table id="invoiceTable">
          <thead>
            <tr><th>Invoice</th><th>Client</th><th>Date</th><th>Due</th><th>Amount</th><th>Status</th><th></th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Form modals (hidden areas) -->
    <div id="modals">

      <!-- Client Modal -->
      <div class="card" id="clientForm" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:720px;z-index:60">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div><strong id="clientFormTitle">New Client</strong></div>
          <div><button id="btnCloseClient" class="btn-ghost">Close</button></div>
        </div>

        <div class="grid" style="grid-template-columns:1fr 1fr">
          <div>
            <label>Client Name</label>
            <input id="client_name" placeholder="Acme Inc."/>

            <label>Contact Person</label>
            <input id="client_contact" placeholder="John Doe"/>

            <label>Email</label>
            <input id="client_email" placeholder="contact@acme.com"/>

            <label>Phone</label>
            <input id="client_phone" placeholder="+91 9876543210"/>
          </div>

          <div>
            <label>Address</label>
            <textarea id="client_address" rows="5" placeholder="Street, City, State, ZIP"></textarea>

            <label>Tax ID / GSTIN</label>
            <input id="client_tax" placeholder="Optional"/>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="saveClientBtn">Save Client</button>
              <button id="deleteClientBtn" class="btn-ghost" style="display:none">Delete</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Invoice Modal -->
      <div class="card" id="invoiceForm" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:1000px;z-index:70;max-height:90vh;overflow:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
          <div><strong id="invoiceFormTitle">New Invoice</strong></div>
          <div><button id="btnCloseInvoice" class="btn-ghost">Close</button></div>
        </div>

        <div class="grid" style="grid-template-columns:1fr 320px;gap:14px">
          <div>
            <div style="display:flex;gap:8px">
              <div style="flex:1">
                <label>Client</label>
                <select id="invoice_client"></select>
              </div>
              <div style="width:140px">
                <label>Invoice #</label>
                <input id="invoice_number"/>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <label>Invoice Date</label>
                <input id="invoice_date" type="date"/>
              </div>
              <div style="width:140px">
                <label>Due Date</label>
                <input id="invoice_due" type="date"/>
              </div>
            </div>

            <div style="margin-top:10px">
              <label>Line Items</label>
              <div class="line-items" id="lineItems"></div>
              <div style="margin-top:8px; display:flex; gap:8px">
                <button id="addLineBtn" class="btn-ghost">+ Add line</button>
                <button id="clearLines" class="btn-ghost">Clear</button>
              </div>
            </div>

            <div style="display:flex;gap:8px;margin-top:8px">
              <div style="flex:1">
                <label>Notes (printed on invoice)</label>
                <textarea id="invoice_notes" rows="3"></textarea>
              </div>
              <div style="width:220px">
                <label>Tax (%)</label>
                <input id="invoice_tax" type="number" value="0"/>
                <label style="margin-top:6px">Discount (%)</label>
                <input id="invoice_discount" type="number" value="0"/>
                <label style="margin-top:6px">Tax Mode</label>
                <select id="taxMode">
                  <option value="exclusive">Exclusive</option>
                  <option value="inclusive">Inclusive</option>
                </select>
              </div>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px">
              <button id="saveInvoiceBtn">Save Invoice</button>
              <button id="sendInvoiceBtn" class="btn-ghost">Mark Sent</button>
              <button id="markPaidBtn" class="btn-ghost">Mark Paid</button>
              <button id="cloneInvoiceBtn" class="btn-ghost">Duplicate</button>
              <button id="deleteInvoiceBtn" class="btn-ghost" style="background:transparent">Delete</button>
            </div>
          </div>

          <div>
            <div class="template-preview card" id="previewBox">
              <div style="display:flex;justify-content:space-between">
                <div><strong id="previewClient">Client Name</strong><div class="muted small" id="previewAddress">Client address</div></div>
                <div><div class="small muted">Invoice</div><div id="previewNumber">INV-000</div></div>
              </div>

              <div style="margin-top:12px;border-top:1px dashed #edf4fb;padding-top:10px">
                <div id="previewItems"></div>
                <div class="total-row">
                  <div class="small muted">Subtotal</div>
                  <div id="previewSubtotal">0</div>
                </div>
                <div class="total-row">
                  <div class="small muted">Tax</div>
                  <div id="previewTax">0</div>
                </div>
                <div class="total-row">
                  <div class="small muted">Discount</div>
                  <div id="previewDiscount">0</div>
                </div>
                <div class="total-row" style="margin-top:8px">
                  <div class="big-total">Total</div>
                  <div class="big-total" id="previewTotal">0</div>
                </div>

                <div style="margin-top:12px">
                  <label>Pay in crypto (optional)</label>
                  <input id="cryptoAddress" placeholder="Paste crypto address or UPI"/>
                  <div style="margin-top:8px;display:flex;gap:8px;">
                    <select id="cryptoSelect">
                      <option value="">None</option>
                      <option value="bitcoin">Bitcoin (BTC)</option>
                      <option value="ethereum">Ethereum (ETH)</option>
                      <option value="tether">Tether (USDT)</option>
                      <option value="solana">Solana (SOL)</option>
                    </select>
                    <button id="genQR" class="btn-ghost">Generate QR</button>
                  </div>

                  <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
                    <div id="cryptoConverted" class="muted small">—</div>
                  </div>

                  <div style="margin-top:10px">
                    <div id="qrcode" class="qr"></div>
                  </div>
                </div>

              </div>
            </div>

            <div style="margin-top:10px;display:flex;gap:8px;justify-content:space-between">
              <div>
                <div class="small muted">Live crypto prices (USD)</div>
                <div id="priceList" class="small muted">Loading...</div>
              </div>

              <div style="text-align:right">
                <div class="small muted">Actions</div>
                <div style="display:flex;gap:6px;margin-top:6px;justify-content:flex-end">
                  <button id="downloadPDF" class="btn-ghost">Download PDF</button>
                  <button id="previewPrint" class="btn-ghost">Preview</button>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>

    </div>

    <footer class="muted small">Built with ♥ — drop into GitHub repo and deploy to Vercel. Crypto prices via CoinGecko (public API).</footer>
  </div>

  <!-- External libraries -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.9.3/dist/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- Main JS -->
  <script>
  (function(){
    // ---------- Basic utilities ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const ls = { get:(k)=> JSON.parse(localStorage.getItem(k)||'null'), set:(k,v)=>localStorage.setItem(k,JSON.stringify(v)), remove:(k)=>localStorage.removeItem(k) };

    // ---------- App state ----------
    let state = {
      clients: ls.get('clients') || [],
      invoices: ls.get('invoices') || [],
      prices: {}, // crypto prices USD
      editingClient: null,
      editingInvoice: null,
      template: 'simple',
      theme: 'light'
    };

    // ---------- DOM references ----------
    const invoiceTableBody = $('#invoiceTable tbody');
    const statInvoices = $('#statInvoices'), statPaid = $('#statPaid'), statOutstanding = $('#statOutstanding');

    // ---------- Helpers ----------
    function saveState(){ ls.set('clients', state.clients); ls.set('invoices', state.invoices); }
    function uid(prefix='id'){ return prefix + Math.random().toString(36).slice(2,9).toUpperCase(); }
    function formatDate(d){ if(!d) return ''; const dt = new Date(d); return dt.toLocaleDateString(); }
    function dateISO(offsetDays=0){ const d = new Date(); d.setDate(d.getDate()+offsetDays); return d.toISOString().slice(0,10); }

    // ---------- Invoice calculations ----------
    function calcInvoice(inv){
      // inv.lines: [{desc,qty,rate}]
      const lines = inv.lines || [];
      let subtotal = 0;
      for (const l of lines){ const q=Number(l.qty)||0; const r=Number(l.rate)||0; subtotal += q*r; }
      const discountPct = Number(inv.discount)||0;
      const taxPct = Number(inv.tax)||0;
      let discount = subtotal * (discountPct/100);
      let tax = 0;
      if(inv.taxMode === 'inclusive'){
        // tax included in subtotal: tax portion = subtotal * tax/(100+tax)
        tax = subtotal * (taxPct/(100+taxPct));
        // if discount present, apply discount after extracting tax proportionally:
        subtotal = subtotal; // keep for display
      } else {
        tax = (subtotal - discount) * (taxPct/100);
      }
      const total = (inv.taxMode==='inclusive') ? (subtotal - discount) : (subtotal - discount + tax);
      return { subtotal: round2(subtotal), tax: round2(tax), discount: round2(discount), total: round2(total) };
    }
    function round2(v){ return Math.round((v+Number.EPSILON)*100)/100; }

    // ---------- UI: render invoice table & stats ----------
    function renderTable(){
      invoiceTableBody.innerHTML = '';
      const search = $('#searchInput').value.toLowerCase().trim();
      const statusFilter = $('#filterStatus').value;
      const sortMode = $('#sortSelect').value;

      let list = state.invoices.slice();

      if(search){
        list = list.filter(inv => inv.number.toLowerCase().includes(search) || (getClient(inv.clientId)?.name||'').toLowerCase().includes(search));
      }
      if(statusFilter !== 'all'){
        list = list.filter(inv => inv.status === statusFilter);
      }
      // sort
      list.sort((a,b)=>{
        if(sortMode==='date_desc') return new Date(b.date) - new Date(a.date);
        if(sortMode==='date_asc') return new Date(a.date) - new Date(b.date);
        if(sortMode==='amount_desc') return calcInvoice(b).total - calcInvoice(a).total;
        if(sortMode==='amount_asc') return calcInvoice(a).total - calcInvoice(b).total;
        return 0;
      });

      for (const inv of list){
        const c = getClient(inv.clientId);
        const calc = calcInvoice(inv);
        const tr = document.createElement('tr');

        const due = inv.dueDate ? formatDate(inv.dueDate) : '-';
        const date = inv.date ? formatDate(inv.date) : '-';
        const statusPill = `<span class="pill ${inv.status==='paid'?'status-paid':inv.status==='overdue'?'status-overdue':'status-draft'}">${inv.status||'draft'}</span>`;

        tr.innerHTML = `
          <td><strong>${inv.number}</strong><div class="small muted">${inv.notes?inv.notes.slice(0,40):''}</div></td>
          <td>${c ? c.name : '<span class="muted small">Unknown</span>'}</td>
          <td>${date}</td>
          <td>${due}</td>
          <td>₹ ${calc.total.toLocaleString()}</td>
          <td>${statusPill}</td>
          <td style="text-align:right">
            <div class="actions">
              <button class="btn-ghost edit" data-id="${inv.id}">Edit</button>
              <button class="btn-ghost send" data-id="${inv.id}">Send</button>
              <button class="btn-ghost pdf" data-id="${inv.id}">PDF</button>
            </div>
          </td>
        `;
        invoiceTableBody.appendChild(tr);
      }

      // stats
      statInvoices.textContent = state.invoices.length;
      const paidCount = state.invoices.filter(i=>i.status==='paid').length;
      statPaid.textContent = paidCount;
      const outstanding = state.invoices.filter(i=>i.status!=='paid').reduce((s,i)=>s + calcInvoice(i).total,0);
      statOutstanding.textContent = '₹ ' + round2(outstanding).toLocaleString();
    }

    // ---------- Clients ----------
    function openClientForm(client){
      state.editingClient = client || null;
      $('#clientFormTitle').textContent = client ? 'Edit Client' : 'New Client';
      $('#client_name').value = client?.name||'';
      $('#client_contact').value = client?.contact||'';
      $('#client_email').value = client?.email||'';
      $('#client_phone').value = client?.phone||'';
      $('#client_address').value = client?.address||'';
      $('#client_tax').value = client?.tax||'';
      $('#deleteClientBtn').style.display = client ? 'inline-block' : 'none';
      $('#clientForm').style.display = 'block';
    }
    function closeClientForm(){ $('#clientForm').style.display = 'none'; state.editingClient = null; }
    $('#btnNewClient').addEventListener('click',()=>openClientForm(null));
    $('#btnCloseClient').addEventListener('click',closeClientForm);
    $('#saveClientBtn').addEventListener('click',()=>{
      const c = {
        id: state.editingClient?.id || uid('CL'),
        name: $('#client_name').value.trim() || 'Unnamed',
        contact: $('#client_contact').value.trim(),
        email: $('#client_email').value.trim(),
        phone: $('#client_phone').value.trim(),
        address: $('#client_address').value.trim(),
        tax: $('#client_tax').value.trim()
      };
      if(state.editingClient){
        const idx = state.clients.findIndex(x=>x.id===state.editingClient.id);
        state.clients[idx] = c;
      } else {
        state.clients.push(c);
      }
      saveState(); closeClientForm(); refreshClientOptions(); renderTable();
    });
    $('#deleteClientBtn').addEventListener('click',()=>{
      if(!state.editingClient) return;
      state.clients = state.clients.filter(c=>c.id !== state.editingClient.id);
      // also remove or orphan invoices - keep them but remove client ref
      state.invoices = state.invoices.map(inv => inv.clientId === state.editingClient.id ? ({...inv, clientId:null}) : inv);
      saveState(); closeClientForm(); refreshClientOptions(); renderTable();
    });

    function refreshClientOptions(){
      const sel = $('#invoice_client');
      sel.innerHTML = '';
      const empty = document.createElement('option'); empty.value = ''; empty.textContent = '-- select client --'; sel.appendChild(empty);
      for (const c of state.clients){
        const opt = document.createElement('option'); opt.value = c.id; opt.textContent = c.name; sel.appendChild(opt);
      }
    }
    function getClient(id){ return state.clients.find(c=>c.id===id) || null; }

    // ---------- Invoice form ----------
    function openInvoiceForm(inv){
      state.editingInvoice = inv || defaultInvoice();
      $('#invoiceFormTitle').textContent = inv ? 'Edit Invoice' : 'New Invoice';
      // populate fields
      refreshClientOptions();
      $('#invoice_client').value = state.editingInvoice.clientId || '';
      $('#invoice_number').value = state.editingInvoice.number || generateInvoiceNumber();
      $('#invoice_date').value = state.editingInvoice.date || dateISO();
      $('#invoice_due').value = state.editingInvoice.dueDate || dateISO(7);
      $('#invoice_tax').value = state.editingInvoice.tax || 0;
      $('#invoice_discount').value = state.editingInvoice.discount || 0;
      $('#invoice_notes').value = state.editingInvoice.notes || '';
      $('#taxMode').value = state.editingInvoice.taxMode || 'exclusive';
      $('#cryptoAddress').value = state.editingInvoice.crypto || '';
      // line items
      renderLineItems();
      // preview
      renderPreview();
      $('#invoiceForm').style.display = 'block';
    }
    function closeInvoiceForm(){ $('#invoiceForm').style.display='none'; state.editingInvoice=null; }

    $('#btnNewInvoice').addEventListener('click',()=>openInvoiceForm(null));
    $('#btnCloseInvoice').addEventListener('click',closeInvoiceForm);

    function defaultInvoice(){
      return {
        id: uid('INV'),
        clientId: null,
        number: generateInvoiceNumber(),
        date: dateISO(),
        dueDate: dateISO(7),
        lines: [{desc:'Service', qty:1, rate:0}],
        tax:0,
        discount:0,
        taxMode:'exclusive',
        notes:'',
        status:'draft',
        crypto:''
      };
    }
    function generateInvoiceNumber(){
      const n = (state.invoices.length + 1).toString().padStart(4,'0');
      return 'INV-' + new Date().getFullYear().toString().slice(-2) + '-' + n;
    }

    // line items UI
    function renderLineItems(){
      const el = $('#lineItems'); el.innerHTML = '';
      (state.editingInvoice.lines || []).forEach((ln, idx) => {
        const row = document.createElement('div'); row.className='line';
        row.innerHTML = `
          <input data-field="desc" placeholder="Description" value="${escapeHtml(ln.desc)}" />
          <input data-field="qty" type="number" style="width:90px" value="${ln.qty}" />
          <input data-field="rate" type="number" style="width:110px" value="${ln.rate}" />
          <button class="btn-ghost remove" data-idx="${idx}">✕</button>
        `;
        el.appendChild(row);
        // events
        const inputs = row.querySelectorAll('input');
        inputs.forEach(inp => {
          inp.addEventListener('input', () => {
            const field = inp.getAttribute('data-field');
            state.editingInvoice.lines[idx][field] = inp.value;
            renderPreview();
          });
        });
        row.querySelector('.remove').addEventListener('click', ()=>{
          state.editingInvoice.lines.splice(idx,1);
          renderLineItems(); renderPreview();
        });
      });
    }

    $('#addLineBtn').addEventListener('click', ()=>{
      state.editingInvoice.lines = state.editingInvoice.lines || [];
      state.editingInvoice.lines.push({desc:'',qty:1,rate:0});
      renderLineItems(); renderPreview();
    });
    $('#clearLines').addEventListener('click', ()=>{
      state.editingInvoice.lines = [];
      renderLineItems(); renderPreview();
    });

    // live preview
    function renderPreview(){
      const inv = state.editingInvoice;
      $('#previewClient').textContent = getClient(inv.clientId)?.name || 'No client selected';
      $('#previewAddress').textContent = getClient(inv.clientId)?.address || '';
      $('#previewNumber').textContent = inv.number || '';
      const itemsBox = $('#previewItems'); itemsBox.innerHTML = '';
      inv.lines.forEach(ln => {
        const div = document.createElement('div'); div.style.display='flex'; div.style.justifyContent='space-between'; div.style.marginBottom='4px';
        div.innerHTML = `<div class="small">${escapeHtml(ln.desc||'')}</div><div class="small">₹ ${(Number(ln.qty)||0)*(Number(ln.rate)||0)}</div>`;
        itemsBox.appendChild(div);
      });
      const c = calcInvoice(inv);
      $('#previewSubtotal').textContent = '₹ '+c.subtotal;
      $('#previewTax').textContent = '₹ '+c.tax;
      $('#previewDiscount').textContent = '₹ '+c.discount;
      $('#previewTotal').textContent = '₹ '+c.total;
      // crypto convert
      updateCryptoConverted();
    }

    // save invoice
    $('#saveInvoiceBtn').addEventListener('click', ()=>{
      // gather fields
      const inv = state.editingInvoice;
      inv.clientId = $('#invoice_client').value || null;
      inv.number = $('#invoice_number').value || inv.number;
      inv.date = $('#invoice_date').value || dateISO();
      inv.dueDate = $('#invoice_due').value || '';
      inv.tax = Number($('#invoice_tax').value)||0;
      inv.discount = Number($('#invoice_discount').value)||0;
      inv.taxMode = $('#taxMode').value;
      inv.notes = $('#invoice_notes').value||'';
      inv.crypto = $('#cryptoAddress').value||'';
      // persist lines from DOM
      // already kept in state via inputs
      if(!state.invoices.find(i=>i.id===inv.id)){
        state.invoices.push(inv);
      } else {
        const idx = state.invoices.findIndex(i=>i.id===inv.id);
        state.invoices[idx] = inv;
      }
      saveState(); renderTable(); closeInvoiceForm();
    });

    // send/mark paid/clone/delete buttons
    $('#sendInvoiceBtn').addEventListener('click', ()=>{
      if(!state.editingInvoice) return;
      state.editingInvoice.status = 'sent';
      saveState(); renderTable(); renderPreview();
    });
    $('#markPaidBtn').addEventListener('click', ()=>{
      if(!state.editingInvoice) return;
      state.editingInvoice.status = 'paid';
      saveState(); renderTable(); renderPreview();
    });
    $('#cloneInvoiceBtn').addEventListener('click', ()=>{
      if(!state.editingInvoice) return;
      const clone = JSON.parse(JSON.stringify(state.editingInvoice));
      clone.id = uid('INV'); clone.number = generateInvoiceNumber(); clone.status = 'draft';
      state.invoices.push(clone); saveState(); renderTable();
    });
    $('#deleteInvoiceBtn').addEventListener('click', ()=>{
      if(!state.editingInvoice) return;
      state.invoices = state.invoices.filter(i=>i.id !== state.editingInvoice.id);
      saveState(); renderTable(); closeInvoiceForm();
    });

    // table actions (edit/pdf/send)
    invoiceTableBody.addEventListener('click', (e)=>{
      const el = e.target;
      if(el.matches('.edit')) {
        const id = el.dataset.id;
        const inv = state.invoices.find(i=>i.id===id);
        if(inv) openInvoiceForm(JSON.parse(JSON.stringify(inv))); // edit copy
      } else if(el.matches('.send')){
        const id = el.dataset.id;
        const inv = state.invoices.find(i=>i.id===id);
        if(inv){ inv.status='sent'; saveState(); renderTable(); alert('Marked as Sent'); }
      } else if(el.matches('.pdf')){
        const id = el.dataset.id;
        const inv = state.invoices.find(i=>i.id===id);
        if(inv) downloadInvoicePDF(inv);
      }
    });

    // export CSV
    $('#btnExportCSV').addEventListener('click', ()=>{
      const rows = [['Invoice#','Client','Date','Due','Subtotal','Tax','Discount','Total','Status','Notes']];
      for (const inv of state.invoices){
        const c = calcInvoice(inv);
        rows.push([inv.number, getClient(inv.clientId)?.name||'', inv.date||'', inv.dueDate||'', c.subtotal, c.tax, c.discount, c.total, inv.status, (inv.notes||'').replace(/\n/g,' ')]);
      }
      const csv = rows.map(r => r.map(cell => `"${String(cell||'').replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='invoices.csv'; a.click(); URL.revokeObjectURL(url);
    });

    // PDF: generate a simple invoice HTML and use html2pdf
    function downloadInvoicePDF(inv){
      const client = getClient(inv.clientId) || {name:'Unknown', address:''};
      const calc = calcInvoice(inv);
      const el = document.createElement('div');
      el.style.padding='20px'; el.style.fontFamily='Inter,Arial,Helvetica';
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><h2>Invoice</h2><div>${client.name}</div><div style="margin-top:8px">${client.address||''}</div></div>
          <div style="text-align:right"><div><strong>${inv.number}</strong></div><div>Date: ${inv.date}</div><div>Due: ${inv.dueDate||'—'}</div></div>
        </div>
        <hr style="margin:12px 0"/>
        <div>
          ${inv.lines.map(l=>`<div style="display:flex;justify-content:space-between;margin:6px 0"><div>${escapeHtml(l.desc)}</div><div>${l.qty} x ${l.rate} = ₹ ${round2((Number(l.qty)||0)*(Number(l.rate)||0))}</div></div>`).join('')}
        </div>
        <hr/>
        <div style="display:flex;flex-direction:column;align-items:flex-end">
          <div>Subtotal: ₹ ${calc.subtotal}</div>
          <div>Tax: ₹ ${calc.tax}</div>
          <div>Discount: -₹ ${calc.discount}</div>
          <div style="font-weight:700;font-size:18px;margin-top:6px">Total: ₹ ${calc.total}</div>
        </div>
        <div style="margin-top:16px">${escapeHtml(inv.notes||'')}</div>
      `;
      const opt = { margin:10, filename: `${inv.number}.pdf`, image:{type:'jpeg',quality:0.98}, html2canvas:{scale:2}, jsPDF:{unit:'mm',format:'a4',orientation:'portrait'} };
      html2pdf().set(opt).from(el).save();
    }

    // download current preview invoice
    $('#downloadPDF').addEventListener('click', ()=>{
      if(!state.editingInvoice) return alert('Open an invoice to download');
      downloadInvoicePDF(state.editingInvoice);
    });

    // preview print (open small printable view)
    $('#previewPrint').addEventListener('click', ()=>{
      if(!state.editingInvoice) return alert('Open an invoice to preview');
      const inv = state.editingInvoice;
      const calc = calcInvoice(inv);
      const w = window.open('','_blank','width=800,height=800');
      const html = `
        <html><head><title>${inv.number}</title><style>body{font-family:Inter,Arial;padding:20px;color:#111} .big{font-weight:700}</style></head>
        <body>
          <h2>Invoice ${inv.number}</h2>
          <div>Client: ${escapeHtml(getClient(inv.clientId)?.name || '—')}</div>
          <div style="margin-top:10px">
            ${inv.lines.map(l=>`<div>${escapeHtml(l.desc)} - ${l.qty} x ${l.rate} = ₹ ${round2((Number(l.qty)||0)*(Number(l.rate)||0))}</div>`).join('')}
          </div>
          <div style="margin-top:10px" class="big">Total: ₹ ${calc.total}</div>
          <div style="margin-top:20px">${escapeHtml(inv.notes||'')}</div>
        </body></html>
      `;
      w.document.write(html); w.document.close();
    });

    // ---------- Crypto prices ----------
    async function fetchPrices(){
      try {
        // CoinGecko public API - no key required
        const ids = ['bitcoin','ethereum','tether','solana'];
        const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=' + ids.join(',') + '&vs_currencies=usd');
        const data = await resp.json();
        state.prices = data;
        renderPrices();
      } catch(err){
        console.error('Price fetch failed',err);
        $('#priceList').textContent = 'Price fetch failed';
      }
    }
    function renderPrices(){
      const p = state.prices;
      const parts = [];
      if(p.bitcoin) parts.push('BTC $' + p.bitcoin.usd);
      if(p.ethereum) parts.push('ETH $' + p.ethereum.usd);
      if(p.tether) parts.push('USDT $' + p.tether.usd);
      if(p.solana) parts.push('SOL $' + p.solana.usd);
      $('#priceList').textContent = parts.join(' • ');
      updateCryptoConverted();
    }
    $('#btnRefreshPrices').addEventListener('click', ()=> fetchPrices());

    // convert preview total to selected crypto
    function updateCryptoConverted(){
      const inv = state.editingInvoice;
      if(!inv) { $('#cryptoConverted').textContent='—'; return; }
      const sel = $('#cryptoSelect').value;
      const calc = calcInvoice(inv);
      if(!sel || !state.prices || !state.prices[sel]) {
        $('#cryptoConverted').textContent = '—';
        return;
      }
      const usd = calc.total * 0.012; // placeholder rupee -> usd? We should assume INR to USD conversion unknown. We'll do a basic approximate: 1 USD = 83 INR
      // Better: treat totals as INR and convert to USD via a conservative rate.
      const inrToUsd = 1/83; // approx; you can replace with live FX if desired
      const usdTotal = calc.total * inrToUsd;
      const priceUsd = state.prices[sel].usd;
      const amountCrypto = round2(usdTotal / priceUsd);
      $('#cryptoConverted').textContent = `${amountCrypto} ${sel.toUpperCase()} ≈ $${round2(usdTotal)} (est)`;
    }

    // QR code
    let qrcodeInstance = null;
    $('#genQR').addEventListener('click', ()=>{
      const value = $('#cryptoAddress').value.trim();
      if(!value) return alert('Paste a crypto address or payment URI first');
      const qEl = document.getElementById('qrcode'); qEl.innerHTML='';
      qrcodeInstance = new QRCode(qEl, { text: value, width:120, height:120 });
    });

    // when crypto select changes, update conversion
    $('#cryptoSelect').addEventListener('change', updateCryptoConverted);

    // ---------- utilities ----------
    function escapeHtml(s){ return String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

    // ---------- setup initial event wiring ----------
    $('#filterStatus').addEventListener('change', renderTable);
    $('#sortSelect').addEventListener('change', renderTable);
    $('#searchInput').addEventListener('input', renderTable);
    $('#templateSelect').addEventListener('change', (e)=>{ state.template = e.target.value; });
    $('#themeSelect').addEventListener('change', (e)=>{ state.theme = e.target.value; document.getElementById('app').setAttribute('data-theme', state.theme); });
    $('#invoice_client').addEventListener('change', ()=>{ state.editingInvoice.clientId = $('#invoice_client').value; renderPreview(); });
    $('#invoice_number').addEventListener('input', ()=>{ state.editingInvoice.number = $('#invoice_number').value; renderPreview(); });
    $('#invoice_date').addEventListener('change', ()=>{ state.editingInvoice.date = $('#invoice_date').value; renderPreview(); });
    $('#invoice_due').addEventListener('change', ()=>{ state.editingInvoice.dueDate = $('#invoice_due').value; renderPreview(); });
    $('#invoice_tax').addEventListener('input', ()=>{ state.editingInvoice.tax = Number($('#invoice_tax').value)||0; renderPreview(); });
    $('#invoice_discount').addEventListener('input', ()=>{ state.editingInvoice.discount = Number($('#invoice_discount').value)||0; renderPreview(); });
    $('#invoice_notes').addEventListener('input', ()=>{ state.editingInvoice.notes = $('#invoice_notes').value; renderPreview(); });
    $('#cryptoAddress').addEventListener('input', ()=>{ state.editingInvoice.crypto = $('#cryptoAddress').value; });

    // ---------- initial load ----------
    function init(){
      refreshClientOptions();
      renderTable();
      fetchPrices();
      // initial theme
      document.getElementById('app').setAttribute('data-theme', state.theme);
      $('#themeSelect').value = state.theme;
      // populate with demo if empty
      if(state.clients.length===0 && state.invoices.length===0){
        state.clients.push({id:uid('CL'), name:'Acme Ltd', contact:'Alice', email:'alice@acme.com', phone:'', address:'123, Market St\nMumbai', tax:'GSTIN123'});
        state.clients.push({id:uid('CL'), name:'Beta Co', contact:'Ravi', email:'ravi@beta.com', phone:'', address:'45, MG Road\nPune', tax:''});
        const demo = defaultInvoice();
        demo.clientId = state.clients[0].id;
        demo.lines = [{desc:'Website design', qty:1, rate:20000},{desc:'Hosting (1 yr)', qty:1, rate:2000}];
        demo.tax = 18; demo.discount=0; demo.notes='Thank you for your business'; demo.status='sent';
        state.invoices.push(demo);
        saveState();
      }
      refreshClientOptions();
      renderTable();
    }
    init();

    // expose small functions for debugging in console
    window.InvoiceGen = { state, saveState, fetchPrices };
  })();
  </script>
</body>
</html>
